# Lab1: Simple Matrix Multiplication

## Description
Design an HLS kernel named 'mm', which computes the product of two matrixes ($C_{i,j}=\sum_{k} A_{i, k} * B_{k, j}$).  See the example codes under `.\srcs` for reference. We have the following constraints:
* Remain the file structure and names (`matmul.h`, `matmul.cpp`, `matmul_tb.cpp`) unchanged.
* Use `mm` as the kernel name.
* Use `m_axi` interface for `A`, `B`, `C` as the example design does. **But you may change their data types or modify interface attributes.**
* You MUST create a local array to store matrix B (like `local_B` in example code).
* `script.tcl` contains some synthesis configurations. Please don't modify them.
  * "Disable automatic array partitioning".
  * "Allow unsafe math optimizations".
* Follow the annotations in the example design. Please don't make any illegal changes.
* Set target period as 200ms. We allow the timing violation.
* Flow target is "Vivado IP"
* Choose part "xc7z020-clg400-1".

### Submission

You have to submit:

1. `srcs` directory under which there are your design files (`matmul.cpp, matmul.h, matmul_tb.cpp`);
2. One report (`.docx, .pdf` ) briefly describe your optimization. (**We don't care about the number of words in your report!**  Just make it as simple as possible.)

Please compress them and send `[name]-[schoolID].zip` to shallwe@pku.edu.cn. The email caption should be as the same as the `.zip` file.

Due of the assignment: 2022.03.25 23:59:59

## Usage

TA provides a python script `test.py` for evaluation. It executes `tb_gen.py` to generate a random test case under `.\srcs`. Then, it executes `script.tcl` to create the HLS project named `hw1_mm`, add the codes and data under `.\srcs`, and apply C Simulation and Synthesis. It will automatically fetch the C Simulation result and score the Synthesis result from the reports provides by the Vitis HLS tool. 

For the usage of `test.py`:
1. Install Python (TA uses Python 3.7.9) and NumPy first. 
2. Configure Vitis HLS installation path and the Python Command in `test.py` 
3. Close the Vitis HLS GUI (if open), then run

```shell
python test.py
```

`tb_gen.py` generates two random matrixs. Each one is generated by `np.trunc(np.random.rand(r, c) * (1<<8)) / (1<<3)`. So each element of the matrixs has at most 5 integer bits and 3 fractional bits.

##  Evaluation

TA gives a score board as shown below. For each row, if both the latency and all resource metrics meet the requirements, your design could get the score. Your final score is certainly the highest score of your design.

>  Note that, we use percentage for resource metrics.

```
| Latency  | BRAM% | DSP% | FF%  | LUT% | Score |
| -------- | ----- | ---- | ---- | ---- | ----- |
| x        | >100  | >100 | >100 | >100 | 0     |
| 11999999 | 95    | 90   | 40   | 60   | 10    |
| 1699999  | 95    | 90   | 40   | 60   | 20    |
| 1699999  | 30    | 90   | 25   | 50   | 30    |
| 699999   | 30    | 15   | 10   | 15   | 50    |
| 99999    | 20    | 10   | 5    | 10   | 80    |
| 79999    | 20    | 10   | 5    | 10   | 90    |
| 19999    | 20    | 10   | 5    | 10   | 100   |
```

## Suggestions

TA gives the following suggestions:

* Get familiar with the HLS design methodology. Our course gives a brief and practical introduction. You may also refer to [**Vitis High-Level Synthesis User Guide (UG1399)**](https://docs.xilinx.com/r/en-US/ug1399-vitis-hls) (Especially the first two chapters) for more information.
* The default optimization applied by Vitis HLS may be **harmful**. You may disable them first, for example, `#pragma HLS pipeline off`.
* The following optimization techniques may help you get full grade:
  * Loop unrolling \ pipelining
  * Array partitioning
  * Arbitrary data type (look at `tb_gen.py` to choose the appropriate data type)
  * Compositive data type (Struct) and data aggregation
  * Dataflow (you don't need to design a streaming architecture for this project).
* Read the `readme.md` line by line.
* **Please refer to the reference solution of MVM (matrix-vector multiplication) lab**.

## Online Judge

http://118.31.188.115:8008/tenant/problem/87

For submission, please click "项目下载" and replace files under `srcs` with your own design files. Compress the directory again and submit the `.zip` file.

